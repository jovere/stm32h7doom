# OpenOCD Configuration for STM32H750 with MT25QL512ABB QSPI Flash
# FIXED VERSION - GPIO AF configuration corrected, Line 73 removed
# Usage: openocd -f openocd/stm32h750_qspi.cfg

# ============================================================================
# Debug Interface Configuration
# ============================================================================

source [find interface/stlink-dap.cfg]
transport select dapdirect_swd

# ============================================================================
# Target Configuration
# ============================================================================

set CHIPNAME stm32h750xbh6

# enable stmqspi
if {![info exists QUADSPI]} {
    set QUADSPI 1
}

source [find target/stm32h7x.cfg]

reset_config srst_only
stm32h750xbh6.swo configure -output :12345 -protocol uart -formatter 1 -traceclk 480000000
stm32h750xbh6.swo enable
itm ports on

# ============================================================================
# QSPI Flash Bank Configuration
# ============================================================================
proc qspi_init { qpi } {
	global a
	# Enable GPIO clocks for ports B, F, G
	mmw 0x580244E0 0x00000062 0				;# RCC_AHB4ENR |= GPIOBEN(bit1) | GPIOFEN(bit5) | GPIOGEN(bit6)
	mmw 0x580244D4 0x00004000 0				;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1									;# Wait for clock startup

	# Custom STM32H750 pinout (single bank):
	# PB2: CLK (AF9)
	# PG6: BK1_NCS (AF10)
	# PF6: BK1_IO3 (AF9)  - FIXED!
	# PF7: BK1_IO2 (AF9)  - FIXED!
	# PF8: BK1_IO0 (AF10)
	# PF9: BK1_IO1 (AF10)

	# Port B: PB2:AF09:V (CLK)
	# MODER: bits[5:4] = 10 (alternate function)
	mmw 0x58020400 0x00000020 0x00000010	;# MODER
	mmw 0x58020408 0x00000030 0x00000000	;# OSPEEDR (very high speed)
	mmw 0x58020420 0x00000900 0x00000600	;# AFRL: AF9 for PB2

	# Port F: PF6-PF9 (IO3, IO2, IO0, IO1)
	# MODER: bits[19:12] = 10 10 10 10 (alternate function for pins 6-9)
	mmw 0x58021400 0x000AA000 0x00055000	;# MODER
	mmw 0x58021408 0x000FF000 0x00000000	;# OSPEEDR (very high speed)
	mmw 0x58021420 0x99000000 0x66000000	;# AFRL: AF9 for PF6-PF7 (IO3, IO2) - FIXED!
	mmw 0x58021424 0x000000AA 0x00000055	;# AFRH: AF10 for PF8-PF9 (IO0, IO1)

	# Port G: PG6:AF10:H (NCS)
	# MODER: bits[13:12] = 10 (alternate function)
	mmw 0x58021800 0x00002000 0x00001000	;# MODER
	mmw 0x58021808 0x00003000 0x00000000	;# OSPEEDR (very high speed)
	mmw 0x5802180C 0x00001000 0x00000000	;# PUPDR: pull-up on NCS
	mmw 0x58021820 0x0A000000 0x05000000	;# AFRL: AF10 for PG6

	# Configure QSPI peripheral for SINGLE BANK mode
	# MT25QL512ABB = 64MB = 2^26 bytes, so FSIZE = 25 (0x19)
	# PRESCALER=5 for ~10.7MHz (HSI 64MHz / 6)
	# DFM=0 (single flash mode), SSHIFT=1 (sample shift), FSEL=0 (Flash 1), FTHRES=0
	mww 0x52005000 0x05500018				;# QUADSPI_CR: PRESCALER=5, APMS=1, FTHRES=0, FSEL=0, DFM=0, SSHIFT=1, TCEN=1
	mww 0x52005004 0x00190200				;# QUADSPI_DCR: FSIZE=0x19 (64MB), CSHT=0x02, CKMODE=0

	mww 0x52005030 0x00001000				;# QUADSPI_LPTR: deactivate CS after 4096 clocks when FIFO is full
	mmw 0x52005000 0x00000001 0				;# QUADSPI_CR: EN=1

	# Exit QPI mode (in case flash is in QPI mode from previous session)
	mmw 0x52005000 0x00000002 0				;# QUADSPI_CR: ABORT=1
	mww 0x52005014 0x000003F5				;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x3, INSTR=Exit QPI
	sleep 1

	if { $qpi == 1 } {
		# Write Enable
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005014 0x00000106			;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=Write Enable
		sleep 1

		# Configure dummy clocks via volatile configuration register
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005010 0x00000001			;# QUADSPI_DLR: 2 data bytes
		mww 0x52005014 0x01000181			;# QUADSPI_CCR: FMODE=0x0, DMODE=0x1, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=Write Volatile Conf. Reg.
		mwh 0x52005020 0xABAB				;# QUADSPI_DR: 0xAB 0xAB for 10 dummy clocks
		sleep 1

		# Write Enable
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005014 0x00000106			;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=Write Enable
		sleep 1

		# Enable QPI mode via enhanced volatile configuration register
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005010 0x00000001			;# QUADSPI_DLR: 2 data bytes
		mww 0x52005014 0x01000161			;# QUADSPI_CCR: FMODE=0x0, DMODE=0x1, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=Write Enhanced Conf. Reg.
		mwh 0x52005020 0x3F3F				;# QUADSPI_DR: 0x3F 0x3F to enable QPI and DPI mode
		sleep 1

		# Enter QPI mode
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005014 0x00000135			;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=Enter QPI
		sleep 1

		# memory-mapped fast read mode with 4-byte addresses and 10 dummy cycles (for read only)
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005014 0x0F283FEC			;# QUADSPI_CCR: FMODE=0x3, DMODE=0x3, DCYC=0xA, ADSIZE=0x3, ADMODE=0x3, IMODE=0x3, INSTR=Fast READ
	} else {
		# memory-mapped read mode with 4-byte addresses
		mmw 0x52005000 0x00000002 0			;# QUADSPI_CR: ABORT=1
		mww 0x52005014 0x0D003513			;# QUADSPI_CCR: FMODE=0x3, DMODE=0x1, DCYC=0x0, ADSIZE=0x3, ADMODE=0x1, IMODE=0x1, INSTR=READ
	}
}

$_CHIPNAME.cpu0 configure -event reset-init {
	global QUADSPI

	mmw 0x52002000 0x00000004 0x0000000B	;# FLASH_ACR: 4 WS for 192 MHZ HCLK

	mmw 0x58024400 0x00000001 0x00000018	;# RCC_CR: HSIDIV=1, HSI on
	mmw 0x58024410 0x10000000 0xEE000007	;# RCC_CFGR: MCO2=system, MCO2PRE=8, HSI as system clock
	mww 0x58024418 0x00000040				;# RCC_D1CFGR: D1CPRE=1, D1PPRE=2, HPRE=1
	mww 0x5802441C 0x00000440				;# RCC_D2CFGR: D2PPRE2=2, D2PPRE1=2
	mww 0x58024420 0x00000040				;# RCC_D3CFGR: D3PPRE=2
	mww 0x58024428 0x00000040				;# RCC_PPLCKSELR: DIVM3=0, DIVM2=0, DIVM1=4, PLLSRC=HSI
	mmw 0x5802442C 0x0001000C 0x00000002	;# RCC_PLLCFGR: PLL1RGE=8MHz to 16MHz, PLL1VCOSEL=wide
	mww 0x58024430 0x01070217				;# RCC_PLL1DIVR: 192 MHz: DIVR1=2, DIVQ=8, DIVP1=2, DIVN1=24
	mmw 0x58024400 0x01000000 0				;# RCC_CR: PLL1ON=1
	sleep 1
	mmw 0x58024410 0x00000003 0				;# RCC_CFGR: PLL1 as system clock
	sleep 1

	adapter speed 4000

	if { $QUADSPI } {
		echo "Initializing QSPI with QPI mode enabled"
		qspi_init 1
	}
}